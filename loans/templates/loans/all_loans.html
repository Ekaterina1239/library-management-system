{% extends 'base.html' %}

{% block title %}All Loans - Library System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>All Loans</h2>
    <div class="btn-group">
        <a href="{% url 'all_loans' %}" class="btn btn-outline-primary {% if not request.GET.status %}active{% endif %}">All</a>
        <a href="{% url 'all_loans' %}?status=active" class="btn btn-outline-success {% if request.GET.status == 'active' %}active{% endif %}">Active</a>
        <a href="{% url 'all_loans' %}?status=overdue" class="btn btn-outline-danger {% if request.GET.status == 'overdue' %}active{% endif %}">Overdue</a>
        <a href="{% url 'all_loans' %}?status=returned" class="btn btn-outline-secondary {% if request.GET.status == 'returned' %}active{% endif %}">Returned</a>
    </div>
</div>

<!-- Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h4 class="card-title">{{ stats.total_loans }}</h4>
                <p class="card-text">Total Loans</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h4 class="card-title">{{ stats.active_loans }}</h4>
                <p class="card-text">Active Loans</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h4 class="card-title">{{ stats.overdue_loans }}</h4>
                <p class="card-text">Overdue Loans</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-secondary text-white">
            <div class="card-body text-center">
                <h4 class="card-title">{{ stats.returned_loans }}</h4>
                <p class="card-text">Returned Loans</p>
            </div>
        </div>
    </div>
</div>

{% if loans %}
<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>User</th>
                <th>Book</th>
                <th>Borrowed Date</th>
                <th>Due Date</th>
                <th>Returned Date</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for loan in loans %}
            <tr>
                <td>
                    <strong>{{ loan.user.username }}</strong>
                    <br>
                    <small class="text-muted">{{ loan.user.first_name }} {{ loan.user.last_name }}</small>
                </td>
                <td>
                    <strong>
                        <a href="{% url 'book_detail' loan.book.pk %}">{{ loan.book.title }}</a>
                    </strong>
                    <br>
                    <small class="text-muted">{{ loan.book.author.first_name }} {{ loan.book.author.last_name }}</small>
                </td>
                <td>{{ loan.borrowed_date|date:"M d, Y" }}</td>
                <td>
                    <span class="{% if loan.is_overdue %}text-danger fw-bold{% endif %}">
                        {{ loan.due_date|date:"M d, Y" }}
                    </span>
                </td>
                <td>
                    {% if loan.returned_date %}
                    {{ loan.returned_date|date:"M d, Y" }}
                    {% else %}
                    <span class="text-muted">Not returned</span>
                    {% endif %}
                </td>
                <td>
                    {% if loan.returned_date %}
                    <span class="badge bg-success">Returned</span>
                    {% elif loan.is_overdue %}
                    <span class="badge bg-danger">Overdue</span>
                    {% else %}
                    <span class="badge bg-primary">Active</span>
                    {% endif %}
                </td>
                <td>
                    {% if not loan.returned_date %}
                    <form method="post" action="{% url 'return_book' loan.pk %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-success btn-sm" title="Mark as Returned">
                            <i class="fas fa-check"></i> Return
                        </button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if page_obj.has_other_pages %}
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Previous</a>
        </li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
        <li class="page-item {% if page_obj.number == num %}active{% endif %}">
            <a class="page-link" href="?page={{ num }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">{{ num }}</a>
        </li>
        {% endfor %}

        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Next</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="alert alert-info text-center">
    <h5>No Loans Found</h5>
    <p>No loans match the selected criteria.</p>
</div>
{% endif %}
{% endblock %}